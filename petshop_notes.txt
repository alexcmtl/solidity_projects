Tutorial for building a dapp

idea: A pet shop wants to associate an Ethereum address with a pet that
can be adopted by someone.

There are 16 pets and the database with their info is already setup.
There is also a website for adopting them.
We want to write the smart contract and front-end logic for its usage.

###########################

Setting up the environment:
We require Node.js and Git
Then we do:
npm install -g truffle
Finally download Ganache from https://trufflesuite.com/ganache

Creating a Truffle project:
mkdir pet-shop-tutorial
cd pet-shop-tutorial
truffle unbox pet-shop 

(another useful command is 'truffle init' to create an empty project)

############################

The directory structure:
contracts/: contains .sol files for the smart contracts
There's an important file Migrations.sol

migrations/: a migration is an additional smart contract that keeps track
of changes

test/: contains the JS and Solidity tests for our smart contracts

truffle-config.js: this is the config file

#########################################

Writing The Smart Contract:
In contracts/ create Adoption.sol

the file Adoption.sol contains:

pragma solidity ^0.5.0;

contract Adoption {
	address[16] public adopters; 
}

#############

adopters is an array of addresses, the length of an address is 16
public variables have getter methods

Adopting a pet:

Add the following to Adoption.sol:

//Adopting a pet
function adopt(uint petId) public returns (uint) {
	require(petId >= 0 && petId <= 15);

	adopters[petId] = msg.sender;
	return petId;
}

########

In solidity the types of both the function parameters and the output must be specified. So here the adopt() function takes a uint and returns a uint.
First check that the petId parameter is between 0 and 15 using require().
Then we can make add the address that made the adopt() call to the adopters array. The address of the person or smart contract who called adopt() can be found using msg.sender
We return the petId as confirmation that that pet was adopted.

##########

Add getAdopters() to the contract after the adopt() function:

//Retrieving the adopters
function getAdopters() public view returns (address[16] memory){

	return adopters;

}

#####

Since we already declared the array adopters before, we can just return it.
Note the special return type (address[16] memory) 
The view keyword means the function will not modify the state of the contract.

#####

Compiling and Migrating the contract

go to the root of the directory and type:
truffle compile

A migration is a deployment script meant to alter the state of your dapp's contracts moving it from one state to the next. Sometimes you are deploying new code, sometimes you are replacing a contract.

In migrations/ we have 1_initial_migration.js
This file handles deployment of Migrations.sol

create 2_deploy_contracts.js
add the following to it:

var Adoption = artifacts.require("Adoption");

module.exports = function(deployer) {

	deployer.deploy(Adoption);

};

######

Before we can migrate the contract to the Blockchain, we need to have one running. We use Ganache to do this. Launch Ganache to generate a blockchain running locally on port 7545.

then type:
truffle migrate

You should see the migrations being executed in order followed by some cost info etc.

In Ganache the state of the blockchain should change, it will show that the current block is 4 instead of 0. And the amount of ether in the 1st account should be less than 100.

#####

Testing the smart contract with Solidity:

in test/ create TestAdoption.sol

write this in it:

pragma solidity ^0.5.0;

import "truffle/Assert.sol";
import "truffle/DeployedAddresses.sol";
import "../contracts/Adoption.sol";

contract TestAdoption {
	//this is the address of the smart contract to be tested
	Adoption adoption = Adoption(DeployedAddresses.Adoption());
	
	//this is the id of the pet that we use in the test
	uint expectedPetId = 0;
	
	//this is the expected owner of the pet
	address expectedAdopter = address(this);
}

//Testing adopt()
function testUserCanAdoptPet() public {
	uint returnedId = adoption.adopt(expectedPetId);
	Assert.equal(returnedId, expectedPetId, "Adoption of the expected pet should match what is returned");
}

//Testing retrieval of a pet's owner
function testGetAdopterAddressByPetId() public {
	address adopter = adoption.adopters(expectedPetId);
	Assert.equal(adopter, expectedAdopter, "Owner of the expected pet should be this contract);
}

//Testing retrieval of all the pet's owners
function testGetAdopterAddressByPetIdInArray() public {
	address[16] memory adopters = adoption.getAdopters();
	Assert.equal(adopters[expectedPetId] , expectedAdopter, "The ownder of the expected pet should be this contract");
}

###

Running the tests:

truffle test

  TestAdoption
    ✓ testUserCanAdoptPet (91ms)
    ✓ testGetAdopterAddressByPetId (70ms)
    ✓ testGetAdopterAddressByPetIdInArray (89ms)


  3 passing (670ms)

##########

User Interface of the Dapp [this needs more information]

So far we created a smart contract, deployed it to a local test blockchain, and ran some tests to check that we can interact with it and it does what we wrote. This interaction was done via a terminal console.

We can take it a step further and make a UI for the dapp.

open /src/js/app.js

There is a App object to manage our application

load the pet data in init() and call initWeb3()

The web3 library interacts with the Ethereum blockchain.
It can retrieve user accounts, send transactions, interact with contracts, etc.


Once we can interact with Ethereum via web4 we need to instantiate our
smart contract so web3 knows where to find it and how it works

use the @truffle/contract library 

We first retrieve the artifact file for our smart contract.
Artifacts are info about our contract such as its deployed address and the ABI. The ABI is a JS object that defines how to interact with the contract.

TruffleContract() creates an instance of the contract 

Set its web3 provider using App.web3Provider

call App.markAdopted() function in case any pets are already adopted from a previous visit.













